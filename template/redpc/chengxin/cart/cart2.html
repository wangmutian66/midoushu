<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="renderer" content="webkit">
<title>购物车-{$tpshop_config['shop_info_store_title']}</title>
<meta name="keywords" content="{$tpshop_config['shop_info_store_keyword']}"/>
<meta name="description" content="{$tpshop_config['shop_info_store_desc']}"/>
<link rel="shortcut  icon" type="image/x-icon" href="{$tpshop_config['shop_info_store_ico']}" media="screen"  />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
<link href="__STATIC__/css/style.css?v={$vnum}" rel="stylesheet">
<link href="__STATIC__/css/second.css?v={$vnum}" rel="stylesheet">
<link href="__STATIC__/css/tasp.css?v={$vnum}" rel="stylesheet" /> 
<link href="__STATIC__/css/orderconfirm.css?v={$vnum}" rel="stylesheet" />
<script src="__STATIC__/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="__PUBLIC__/js/global.js?v={$vnum}"></script>
<script src="__PUBLIC__/js/redpc_common.js?v={$vnum}"></script>
<script src="__PUBLIC__/js/layer/layer.js?v={$vnum}"></script> 
<!-- <script src="__PUBLIC__/js/baidu.js"></script> -->
</head>

<body>
    <include file="public/top" />
    <!-- <form name="cart2_form" id="cart2_form" method="post" action="{:U('Homered/Cart/cart3',array('act'=>'submit_order'))}" target="_bland"> -->
    <form name="cart2_form" id="cart2_form" method="post">
        <!--立即购买才会用到-s-->
        <input type="hidden" name="action" value="{$Request.param.action}">
        <input type="hidden" name="goods_id" value="{$Request.param.goods_id}">
        <input type="hidden" name="item_id" value="{$Request.param.item_id}">
        <input type="hidden" name="goods_num" value="{$Request.param.goods_num}">
        <!--立即购买才会用到-e-->
	      <div id="page"> 
            <div class="grid-c"> 
                <div class="address" style="margin-top: 20px;" data-spm="2"> 
                    <h3>确认收货地址 <span class="manage-address"> <!-- <a href="{:U('Home/User/address_list')}">管理收货地址</a> --> </span> </h3> 
                    <div id="ajax_address"><!--ajax 返回收货地址--></div>
                    <div class="address-bar"> <a href="javascript:void(0);" onClick="add_edit_address(0);" class="new J_MakePoint" id="J_NewAddressBtn">使用新地址</a> </div> 
                </div> 
                <div class="address" style="margin-top: 20px;" data-spm="2"> 
                    <h3>自提点</h3> 
                    <div id="ajax_pickup"><!--ajax 返回自提点--></div>
                </div>
                <div> 
                    <h3 class="dib">确认订单信息</h3> 
                  	<table cellspacing="0" cellpadding="0" class="order-table" id="J_OrderTable"> 
                      	<thead> 
                          	<tr> 
    	                       	<th class="s-title">店铺宝贝<hr /></th> 
    	                       	<th class="s-price">单价(米豆)<hr /></th> 
                              <th class="s-midou">米豆兑换(米豆+现金)<hr /></th> 
    	                       	<th class="s-amount">数量<hr /></th> 
    	                       	<th class="s-total">小计(元)<hr /></th> 
                          	</tr> 
                      	</thead> 
					
					              <foreach name="cartList" item="v2" key="k">
	               	          <tbody data-spm="3" class="J_Shop"> 
	                  	          <tr class="first"><td colspan="5"></td></tr> 
	                  	          <tr class="shop blue-line"> 
            	                    	<td colspan="3"> 
            	                    		<!-- 店铺：<a class="J_ShopName J_MakePoint" href="" target="_blank" >{$v2.0.suppliers_id|get_suppliers_name}</a>  -->
            	                        	<span class="seller"><a href="" class="J_MakePoint" >联系卖家</a></span> 
            	                        	<span style="margin-left: 30px;">可用米豆余额：{$user_midou}米豆</span>
            	                    	</td> 
            	                    	<td colspan="2" class="promo"> 
            	                        	<div><ul class="scrolling-promo-hint J_ScrollingPromoHint"></ul></div> 
            	                    	</td> 
          	                  	</tr> 
	                  	          <volist name="v2" id="vo">
              	                  	<tr class="item"> 
              	                      	<td class="s-title"> 
              	                          	<a href="{:U('Homered/Goods/goodsInfo',array('id'=>$vo[goods_id]))}" target="_blank" class="J_MakePoint"> 
              	                              	<img src="{$vo.goods_id|goods_thum_images=52,52,'red'}" class="itempic" />
              	                              	<span class="title J_MakePoint" data-point-url="">{$vo.goods_name}</span>
              	                          	</a> 
              	                          	<div class="props"> 
              	                          		{$vo.spec_key_name}
              	                          	</div> 
              	                      	</td> 
              	                      	<td class="s-price"><span class="price "><em class="style-normal-small-black J_ItemPrice">{$vo.midou_index}</em></span></td>
                                        <td class="s-midou">
                                        	<div style="width:100%;color:#ff0000;margin-bottom:5px">米豆数量设置</div>
                                            <input type="hidden" id="goods_price_{$vo.goods_id}" name="goods_price[{$v2.0.suppliers_id}][{$vo.goods_id}]" value="{$vo.goods_price}" />
                                            <input type="hidden" id="midou_money_{$vo.goods_id}" name="midou_money[{$v2.0.suppliers_id}][{$vo.goods_id}][{$vo.item_id}]" value="{$vo.midou_money}" />
                                            <input type="hidden" id="midou_rate_{$vo.goods_id}" name="midou_rate[{$v2.0.suppliers_id}][{$vo.goods_id}]" value="{$vo.midou_rate}" />
                                            <input type="hidden" id="midou_use_percent_{$vo.goods_id}" name="midou_use_percent[{$v2.0.suppliers_id}][{$vo.goods_id}][{$vo.item_id}]" value="{$vo.midou_use_percent}" />
                                            <input type="hidden" id="max_midou_{$vo.goods_id}" name="max_midou[{$v2.0.suppliers_id}][{$vo.goods_id}][{$vo.item_id}]" value="{$vo.midou}" />
                                            <input type="text" id="midou_{$vo.goods_id}" name="midou[{$v2.0.suppliers_id}][{$vo.goods_id}][{$vo.item_id}]" value="{$vo.midou}" data-goodsid="{$vo.goods_id}" style="width:50px;text-align:center;<if condition="$is_fixedrd eq '1'">background:#ccc;</if>" <if condition="$is_fixedrd eq '1'">readonly</if>  class="midou"  onKeyPress="if((event.keyCode<48 || event.keyCode>57) && event.keyCode!=46 || /\.\d\d$/.test(value))event.returnValue=false" onblur="getMidou({$vo.goods_id},{$vo.item_id})"  />
                                            + 
                                            <span class="price "><em class="style-normal-small-black" id="midou_money_str_{$vo.goods_id}">{$vo.midou_money}</em></span>
                                        </td>
              	                      	<td class="s-amount" data-point-url=""> {$vo['goods_num']} </td> 
              	                      	<td class="s-total"> <span class="price "> <em class="style-normal-bold-red J_ItemTotal ">{$vo.goods_fee}</em> </span> </td> 
                      	            </tr> 
						                    </volist>
	                  	          <tr class="blue-line" style="height: 2px;"><td colspan="5"></td></tr> 
          	                    <tr class="other other-line"> 
          	                      	<td colspan="5"> 
          	                          	<ul class="dib-wrap"> 
          	                              	<li class="dib user-info"> 
          	                                  	<ul class="wrap"> 
          	                                      	<li> 
          	                                          	<div class="field gbook"> 
          	                                              	<label class="label">给卖家留言：</label> 
          	                                              	<textarea style="width:350px;height:80px;" class="tapassa" name="user_note[{$v2.0.suppliers_id}]" onkeyup="checkfilltextarea('.tapassa','50')"></textarea> 
          	                                          	</div> 
          	                                      	</li> 
          	                                  	</ul> 
          	                              	</li> 
          	                              	<li class="dib extra-info"> 
          	                                  	<!-- <div class="shoparea"> 
                                                    <ul class="dib-wrap"> 
                                                        <li class="dib title">店铺优惠：</li> 
                                                        <li class="dib sel"><div class="J_ShopPromo J_Promotion promotion clearfix"></div></li> 
                                                        <li class="dib fee"> 
                                                            <span class="price "> -<em class="style-normal-bold-black J_ShopPromo_Result">0.00</em> </span> 
                                                        </li> 
                                                    </ul> 
                                                </div> 
                                                <div class="shoppointarea"></div>  -->
          	                                  	<!-- <div class="farearea"> 
                                                      <ul class="dib-wrap J_farearea"> 
                                                         <li class="dib title">运送方式：</li> 
                                                         <li class="dib sel"> 
                                                             <select class="J_Fare" onchange="ajax_order_price();" name="shipping_code[{$v2.0.suppliers_id}]"> 
                                                                 <foreach name="v2.0.shippinglist" item="v4" key="k4">
                                                                   <option value="{$v4.code}" >{$v4.name}</option> 
                                                                 </foreach>
                                                             </select> 
                                                         </li> 
                                                         <li class="dib fee"> <span class="price "> <em class="style-normal-bold-red J_FareSum" id="shipping_price_{$v2.0.suppliers_id}">00.00</em> </span> </li> 
                                                      </ul> 
                                                 </div> --> 
          	                                  	<div class="extra-area"> 
          	                                      	<ul class="dib-wrap"> 
          	                                          	<li class="dib title">发货时间：</li> 
          	                                          	<li class="dib content">卖家承诺订单在买家付款后，72小时内发货</li> 
          	                                      	</ul> 
          	                                  	</div> 
          	                              	</li> 
          	                          	</ul> 
          	                      	</td> 
          	                  	</tr> 
          	                  	<tr class="shop-total blue-line"> 
          	                      	<td colspan="5">
                                        店铺合计(<span class="J_Exclude" style="display: none">不</span>含运费)： 
                                        <span class="price g_price ">
                                            <em class="style-middle-bold-red J_ShopTotal" id="midou_{$v2.0.suppliers_id}">00.000</em>  
                                            <span>&yen;</span>
                                            <em class="style-middle-bold-red J_ShopTotal" id="midou_money_{$v2.0.suppliers_id}">00.00</em>
                                            【<span>&yen;</span>
                                            <em class="style-middle-bold-red J_ShopTotal" id="payables_{$v2.0.suppliers_id}">00.00</em>】 
                                            (<span id="postFee_{$v2.0.suppliers_id}">00.00</span>) 
                                        </span> 
                                    </td> 
          	                  	</tr> 
	               	          </tbody>
                            <input type="hidden" name="suppliers_id[{$v2.0.suppliers_id}]" value="{$v2.0.suppliers_id}" />
					              </foreach>

                       	<tfoot> 
                          	<tr> 
                             	  <td colspan="5"> 
                                  	<div class="order-go" data-spm="4"> 
                                     		<div class="J_AddressConfirm address-confirm"> 
                                        		<div class="kd-popup pop-back" style="margin-bottom: 40px;"> 
                                             		<div class="box"> 
                                                  	<div class="bd">
                                                        <div class="point-in"> 
                                                            <em class="t">订单优惠：</em> 
                                                            <span class="price g_price "> <span>&yen;</span><em class="style-large-bold-red" id="order_prom_amount">00.00</em> </span> 
                                                        </div>   
                                                     		<div class="point-in"> 
                                                      			<em class="t">实付款：</em> 
                                                  				  <span class="price g_price "><em class="style-large-bold-red" id="midous">00.000</em> + <span>&yen;</span><em class="style-large-bold-red" id="midou_moneys">00.00</em> </span> 
                                                     		</div> 
                                                     		<ul> 
                                                      			<li><em>寄送至:</em><span id="J_AddrConfirm" style="word-break: break-all;"></span></li> 
                                                      			<li><em>收货人:</em><span id="J_AddrNameConfirm"></span></li> 
                                                     		</ul> 
                                                  	</div> 
                                             		</div> 
                                             		<a href="javascript:history.go(-1);" class="back J_MakePoint" target="_top" data-point-url="">返回购物车</a> 
                                                <a class="btn-go" href="javascript:;" onclick="submit_order();">提交订单<b class="dpl-button"></b></a>
                                         			  <!-- <a class="btn-go" href="javascript:;" onclick="document.getElementById('cart2_form').submit();">提交订单<b class="dpl-button"></b></a> -->
                                        		</div> 
                                     		</div>  
                              		  </div> 
                              	</td> 
                          	</tr> 
                       	</tfoot> 

              	    </table> 
                </div> 
            </div> 
        </div>
    </form>
	  <include file="public/footer" />
<script>


    function getMidou(id){
        var goods_price       = parseFloat($('#goods_price_'+id).val());       // 单价
        var midou_rate        = parseFloat($('#midou_rate_'+id).val());        // 米豆兑换比
        var midou_use_percent = parseFloat($('#midou_use_percent_'+id).val()); // 购买商品 使用米豆 比率
        var max_midou         = parseFloat($('#max_midou_'+id).val()); 
        var midou_money       = parseFloat($('#midou_money_'+id).val());
        var midou             = parseFloat($('#midou_'+id).val());
        
        if( midou==null || midou==undefined || midou=="" || isNaN(midou) ){
            $('#midou_'+id).val(0);
            midou = 0;
        }

        if(midou > max_midou){
            layer.alert('米豆不可多于'+max_midou, {icon: 2});
            $('#midou_'+id).val(max_midou);
            return false;
        } 

        midou_money = goods_price - midou*midou_rate;
		    midou_money = Math.ceil(midou_money*100)/100;
        $('#midou_money_'+id).val(midou_money);
        $('#midou_money_str_'+id).text(midou_money);
        ajax_order_price();
    }
  
    /**
     * 留言字数限制
     * tea ：要限制数字的class名
     * nums ：允许输入的最大值
     * zero ：输入时改变数值的ID
     */
    function checkfilltextarea(tea,nums){
        var len = $(tea).val().length;
        if(len > nums){
            $(tea).val($(tea).val().substring(0,nums));
        }
        var num = nums - len;
        num <= 0 ? $("#zero").text(0): $("#zero").text(num);  //防止出现负数
    }

    $(document).ready(function () {
        ajax_address(); // 获取用户收货地址列表
        self_motion_load();
    });

    /**
     * 新增修改收货地址
     * id 为零 则为新增, 否则是修改
     *  使用 公共的 layer 弹窗插件  参考官方手册 http://layer.layui.com/
     */
    function add_edit_address(id) {
        if (id > 0)
            var url = "/index.php?m=Home&c=User&a=edit_address&scene=1&call_back=call_back_fun&id=" + id; // 修改地址  '{:U('Home/User/add_address',array('scene'=>'1','call_back'=>'call_back_fun','id'=>id))}' //iframe的url /index.php/Home/User/add_address
        else
            var url = "/index.php?m=Home&c=User&a=add_address&scene=1&call_back=call_back_fun";	// 新增地址
        layer.open({
            type: 2,
            title: '添加收货地址',
            shadeClose: true,
            shade: 0.8,
            area: ['880px', '580px'],
            content: url,
        });
    }
    // 添加修改收货地址回调函数
    function call_back_fun(v) {
        layer.closeAll(); // 关闭窗口
        ajax_address(); // 刷新收货地址
    }

    // 删除收货地址
    function del_address(id) {
        layer.confirm('确定要删除吗？', {
                btn: ['确定','取消'] //按钮
            }, function(index){
				layer.close(index);
                // 确定
                $.ajax({
                    url: "/index.php?m=Home&c=User&a=del_address&id=" + id,
                    success: function (data) {
                        ajax_address(); // 刷新收货地址
                        $('#ajax_pickup .order-address-list').removeClass('address_current');
                    }
                });
                layer.closeAll(); // 关闭窗口
            }, function(index){
                layer.close(index);
            }
        );
    }

    /*
     * ajax 获取当前用户的收货地址列表
     */
    function ajax_address() {
        $.ajax({
            url: "{:U('Homered/Cart/ajaxAddress')}",//+tab,
            success: function (data) {
                $("#ajax_address").html('');
                $("#ajax_address").append(data);
                if (data != '') {
                    // 有收货地址列表 再计算价钱
                    ajax_order_price(); // 计算订单价钱
                }else{
                    add_edit_address(0);
                }
            }
        });
    }

    // 切换收货地址
    function swidth_address(obj) {
        var province_id = $(obj).attr('data-province-id');
        var city_id     = $(obj).attr('data-city-id');
        var district_id = $(obj).attr('data-district-id');
        if (typeof($(obj).attr('data-province-id')) != 'undefined') {
            ajax_pickup(province_id,city_id,district_id,0);
        }
        $(".order-address-list").removeClass('address_current');
        $(obj).parent().parent().parent().parent().parent().addClass('address_current');
        ajax_order_price(); // 计算订单价格
    }

    /**
     * 获取用户自提点和推荐自提点
     * @param type 1：用户自提点 ，0：用户自提点和推荐自提点
     * @param province_id 省
     * @param city_id 市
     * @param district_id 区
     */
    function ajax_pickup(province_id, city_id, district_id,show) {
        $.ajax({
            type: 'GET',
            url: "{:U('Homered/Cart/ajaxPickup')}",//+tab,
            data: {province_id: province_id, city_id: city_id, district_id: district_id,show:show},
            success: function (data) {
                $("#ajax_pickup").html('');
                $("#ajax_pickup").append(data);
                ajax_order_price();
            }
        });
    }
    //更换自提点
    function replace_pickup(province_id, city_id, district_id) {
        var url = "/index.php?m=Homered&c=Cart&a=replace_pickup&call_back=call_back_pickup&province_id="+province_id+"&city_id="+city_id+"&district_id="+district_id;
        layer.open({
            type: 2,
            title: '添加收货地址',
            shadeClose: true,
            shade: 0.8,
            area: ['880px', '580px'],
            content: url,
        });
    }
    // 添加自提点地址回调函数
    function call_back_pickup(province_id,city_id,district_id){
        layer.closeAll(); // 关闭窗口
        ajax_pickup(province_id, city_id, district_id,1);
    }

    // 获取订单价格
    function ajax_order_price() {
        $.ajax({
            type : "POST",
            url:"{:U('Homered/Cart/cart3')}",//+tab,g
            data : $('#cart2_form').serialize()+"&act=order_price",// 你的formid
            dataType: "json",
            success: function(data){
                if(data.status != 1)
                {
                    //执行有误
                    layer.alert(data.msg, {icon: 2});
                    // 登录超时g
                    if(data.status == -100)
                        location.hrgef ="{:U('Home/User/login')}";
                    return false;
                }

                $.each(data.result2,function(i,item){  
                    console.log(i+"--"+item.midouFee);  
                    $("#shipping_price_"+i).text(item.postFee);  // 物流费
                    $("#postFee_"+i).text(item.postFee);         // 物流费
                    $("#payables_"+i).text(item.payables);       // 应付
                    $("#midou_"+i).text(item.midouFee);             // 应付 米豆
                    $("#midou_money_"+i).text(item.midou_moneyFee); // 应付 现金
                }); 
                //console.log(data.result.midouFee); 
                $("#midous").text(data.result.midouFee);          // 应付米豆
                $("#midou_moneys").text(data.result.midou_moneyFee);    // 应付现金
                $("#order_prom_amount").text(data.result.order_prom_amount);// 订单 优惠活动
            }
        });
    }

    // 提交订单
    ajax_return_status = 1;
    function submit_order()
    {
        if(ajax_return_status == 0)
            return false;
        ajax_return_status = 0;
        $.ajax({
            type : "POST",
            url:"{:U('Homered/Cart/cart3')}",//+tab,
            data : $('#cart2_form').serialize()+"&act=submit_order",// 你的formid
            dataType: "json",
            success: function(data){

                if(data.status != '1')
                {
                    // alert(data.msg); //执行有误
                    layer.alert(data.msg, {icon: 2});
                    // 登录超时
                    if(data.status == -100)
                        location.href ="{:U('Home/User/login')}";

                    ajax_return_status = 1; // 上一次ajax 已经返回, 可以进行下一次 ajax请求

                    return false;
                }
                layer.msg('订单提交成功，正在跳转!', {
                    icon: 1,   // 成功图标
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                }, function(){ // 关闭后执行的函数
                    location.href = "/index.php?m=Homered&c=Cart&a=cart4&order_sn="+data.result; // 跳转到结算页
                });
            }
        });
    }

  //发票弹窗
    function invoice_dialog() {
        var dh = $(document).height();
        var dw = $(document).width();
        $('.ui-mask').height(dh).width(dw);
        $('.ui-dialog').show();
        $('.ui-mask').show();
        self_motion_load();
    }

    function self_motion_load() {
        $.get("{:U('Cart/invoice')}", function(json) {
            var data = eval("(" + json + ")");
            if (data.status > 0) {
                if(data.result.invoice_title!="个人"){
                    $('#invoice_title').val(data.result.invoice_title);
                    $("#invoice_desc").val(data.result.invoice_desc);
                    $("#taxpayer").val(data.result.taxpayer);
                    $('#adddiv').show();
                    $("#ratepaying").show();
                }

                if (data.result.invoice_desc == "不开发票") {
                    $("#span1,#span2,#span3").hide();
                    $("#span4").show();
                }else{
	                if(data.result.invoice_title!= ""){
	                    $('#invoice_desc').val(data.result.invoice_desc);
	                    $('#span2').text(data.result.invoice_title);
	                    $('#span3').text(data.result.invoice_desc);
	                    $("#span4").hide();
	                    $("#span1,#span2,#span3").show();
	                }
	                $("#invoice_title").css({"border": "2px solid #e4393c"});
	                $("#personage").css({"border": ""});
	                $("#no_invoice").attr("class","item_select_t");
	                $("#detail_invoice").attr("class","item_select_t curtr");
                }
            }else{
                $("#span1,#span2,#span3").hide();
                $("#span4").show();
            }
        });
    }

    $(function() {
        $(document).on('click', '#invoiceBtn', function() {
            var input_invoice = $(this).parents('.ui-dialog-content').find('.invoice_tt');
			      // $('#invoice_title').val(input_invoice.val());
            $('#cart2_form').find("input[name^='invoice_title']").attr('value', input_invoice.val());
            save_invoice() && $('.ui-dialog-close').trigger('click');

            var invoice_title = $("#invoice_title").val();
            var invoice_desc = $("#invoice_desc").val();

            if (invoice_title==""){
                invoice_title="个人";
            }

            $('#span2').text(invoice_title);
            $('#span3').text(invoice_desc);

            if (invoice_desc == "不开发票") {
                $("#span1,#span2,#span3").hide();
                $("#span4").show();
            }else{
                $("#span1,#span2,#span3").show();
                $("#span4").hide();
            }

            $('.ui-dialog').hide();
            $('.ui-mask').hide();

        });
    })
     //关闭弹窗
    $(function() {
        $('.ui-dialog-close').click(function() {
            $('.ui-dialog').hide();
            $('.ui-mask').hide()
        })
    })
    function wield(obj){
        if($.trim($(obj).prev().val()) !=''){
			      // layer.msg('正在计算金额...',{icon:1});
            ajax_order_price(); // 计算订单价钱
        }
    }
</script>
</body>
</html>