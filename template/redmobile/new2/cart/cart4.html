<include file="public/header" title="支付,提交订单" body=""/>
<include file="public/header_nav" title="支付,提交订单" href="javascript:history.back(-1)"/>

    <foreach name="order" item="v" key="k">
    <div class="ddmoney">
        <div class="maleri30">
            <span class="fl">订单号</span>
            <span class="fr">{$v.order_sn}</span>
        </div>
    </div>
    <div class="ddmoney">
        <div class="maleri30">
            <span class="fl">订单金额</span>
            <span class="fr">{$v.midou}米豆 <empty name="$Think.get.store_id">+ {$v.order_amount}</empty>(运费：{$v.shipping_price})</span>
        </div>
    </div>
    
    </foreach>
    <div class="ddmoney">
        <div class="maleri30">
            <span class="fl">米豆数量</span>
            <span class="fr"><span>{$midous}</span>米豆</span>
        </div>
    </div>
    <empty name="$Think.get.store_id">
    <div class="ddmoney">
        <div class="maleri30">
            <span class="fl">支付现金</span>
            <span class="fr"><span>{$order_amounts}</span>元</span>
        </div>
    </div>
    </empty>
<if condition="$order_amounts elt 0" >
    <form action="{:U('Mobilered/Cart/payMidou')}" method="post" name="cart4_form" id="cart4_form"  onsubmit="return false;" >
        <div class="paiton">
            <div class="maleri30">
                <if condition="$order_num eq 1">
                    <input type="hidden" name="order_id" value="{$order[0]['order_id']}"/>
                <else />
                    <input type="hidden" name="order_sn" value="{$order.0.order_sn}"/>
                    <input type="hidden" name="order_id" value="{$order[0]['order_id']}"/>
                </if>
                <input type="hidden" name="order_num" value="{$order_num}"/>
                <input type="hidden" name="store_id" value="{$Think.get.store_id}"/>  <if condition="$Request.param.store_id eq null">
				<div id="payhtml" style=" height: 2rem; line-height: 2rem;">支付密码：<if condition="$paypwd eq null">
                    <if condition="$Request.param.store_id eq null">
                    <a href="{:U('Mobile/User/paypwdedred',array('order_sn'=>$order['0']['order_sn'],'store_id'=>$Request.param.store_id))}" style="color:#f23030;font-size:.6rem;border: 1px red solid;padding: 10px;border-radius: 12px;">点我设置支付密码</a>
                    <else />
                    <a href="{:U('Mobile/User/setMobilestore',array('reason'=>'请设置您的支付信息','order_sn'=>$order['0']['order_sn'],'store_id'=>$Request.param.store_id))}" style="color:#f23030;font-size:.6rem;border: 1px red solid;padding: 10px;border-radius: 12px;">点我设置支付信息</a>
                    </if>
                    <else /><input type="password" autocomplete="new-password" name="paypwd" id="paypwd" placeholder="请输入支付密码" style="width:8rem;height:1.5rem;line-height:1.5rem;border:1px solid #eee;border-radius:5px;padding:0 .5rem"></if></div></if>
                <a class="soon" href="javascript:void(0);" onClick="tkpay()"><span>立即支付米豆</span></a>
            </div>
        </div>
    </form>
	<script>
			function tkpay(){
				var index;
				$.ajax({  
					url: "{:U('Mobilered/Cart/payMidou')}",  
					type: 'POST',  
					data:$("#cart4_form").serialize(),  
					dataType: 'json',  
					beforeSend:function(){
						index = layer.open({type: 2,shadeClose: false});
					},
					error: function(){
						showErrorMsg('系统繁忙，请稍后再试!');
					},
					success: function(r){
						layer.closeAll(index);
						if(r.status == 1){
							showErrorMsg('米豆支付成功!');
                            var store_id = "{$Think.get.store_id}";

							window.setTimeout("location.href = '/Mobilered/Order/order_list/store_id/"+store_id+"';", 2000);
						}else{
							showErrorMsg(r.info);
						}
					}
				});  	
			}
		</script>
<else />
    <form action="{:U('Mobilered/Payment/getCode')}" method="post" name="cart4_form" id="cart4_form">
        <!--其他支付方式-s-->
        <div class="paylist">
            <div class="myorder debit otherpay p">
                <div class="content30">
                    <a href="javascript:void(0);">
                        <div class="order">
                            <div class="fl">
                                <span>支付方式</span>
                            </div>
                            <div class="fr">
                                <!--<i class="Mright xjt"></i>-->
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div class="pay-list-4 p">
            <div class="maleri30" id="pays">
                <ul>
                    <foreach name="paymentList" key="k" item="v">
                        <li style="cursor:pointer;">
                            <label>
                                <div class="radio fl">
        							<span class="che {$k}">
        								<i>
                                            <input type="radio" value="pay_code={$v['code']}" class="c_checkbox_t " name="pay_radio" style="display:none;"/>
                                        </i>
        							</span>
                                </div>
                                <div class="pay-list-img fl">
                                    <img src="/plugins/{$v['type']}/{$v['code']}/{$v['icon']}"/>
                                </div>
                                <div class="pay-list-font fl">
                                    {$v[name]}
                                </div>
                            </label>
                        </li>
                    </foreach>
					<li style="cursor:pointer;">
						<label>
							<div class="radio fl">
								<span class="che 4">
									<i>
									<input type="radio" class="c_checkbox_t" name="pay_radio" value="balance" style="display:none;">
									</i>
								</span>
							</div>
							<div class="pay-list-img fl">
								<!--<img src="__STATIC__/images/logo-2.png"/>-->
								<img src="/template/mobile/new2/static/images/logo-2.png"/>
							</div>
							<div class="pay-list-font fl">
								余额支付
							</div>
						</label>
					</li>
					
                </ul>
				<div id="payhtml" style="display:none; height:1.5rem; line-height:1.5rem;padding-left:10%; margin-top:.5rem;"><input type="password" autocomplete="new-password" name="paypsw" id="paypsw" placeholder="请输入支付密码" style="width:70%;height:1.5rem;line-height:1.5rem;border:1px solid #eee;border-radius:5px;padding:0 10px; font-size:0.68rem"></div>
            </div>
        </div>
        <!--其他支付方式-s-->

        <div class="paiton">
            <div class="maleri30">
                <if condition="$order_num eq 1">
                    <input type="hidden" name="order_id" value="{$order[0]['order_id']}"/>
                <else />
                    <input type="hidden" name="order_sn" value="{$order.0.order_sn}"/>
                    <input type="hidden" name="order_id" value="{$order[0]['order_id']}"/>
                </if>
                <input type="hidden" name="order_num" value="{$order_num}"/>
                <a class="soon" href="javascript:void(0);" onClick="pay()"><span>立即支付</span></a>
                <!--<p class="fr"><a href="javascript:void(0);" class="lossbq">支付失败？</a></p>-->
            </div>
        </div>
    </form>
</if>

<div class="mask-filter-div" style="display: none;"></div>

<script type="text/javascript">
    $(function(){
        //默认选中第一个
        $('.pay-list-4 div ul li:first').find('.che').addClass('check_t').end().find(':radio').attr('checked',true);

        $('#pays').find('li').each(function(){
            $(this).click(function(){

                $(this).find('.che').addClass('check_t').parents('li').siblings('li').find('.che').removeClass('check_t');
                //改变中状态
                if($(this).find('.che').hasClass('check_t')){
                    //选中
                    $(this).find(':radio').attr('checked',true);
                    $(this).siblings('li').find(':radio').removeAttr('checked');
                }else{
                    //取消选中
                    $(this).find(':radio').removeAttr('checked');
                }
                var radio = $("input[name='pay_radio']:checked").val();
                console.log(radio);  
                if(radio == "balance")
                    $("#payhtml").show();
                else 
                    $("#payhtml").hide();
            });
        })

    })


    $(function(){
        //使用银行卡
        $('.usedeb').click(function(){
            cover();
            $('.chooseebitcard').show();
        })
        $('.gb-close').click(function(){
            undercover();
            $('.chooseebitcard').hide();
        })

        //选择银行卡
        $('.card').click(function(){
            $(this).find('.che').toggleClass('check_t').parents('.card').siblings().find('.che').removeClass('check_t');
        })

        //支付失败弹窗
        $('.lossbq').click(function(){
            cover();
            $('.losepay').show();
        })
        $('.qx-rebd .ax').click(function(){
            undercover();
            $('.losepay').hide();
        })
        $('.are').click(function(){
            $('.losepay').hide();
            $('.chooseebitcard').show();
        })
    })


    function ddd(){
        layer.open({
            content: '支付是否成功？'
            ,btn: ['成功', '失败']
            ,yes: function(index){
                location.href = '{:U("/mobilered/Order/order_list/type/WAITSEND")}';
                layer.close(index);
            }
        });   
    }

    function openPay(url){
        window.location.href = url;
        //window.open(url);
    }

    function pay(){
        var radio = $("input[name='pay_radio']:checked").val();
		if(radio == 'pay_code=weixinH5'){
            setTimeout(ddd, 2000);
        }else if(radio == 'balance'){
			var paypsw = $.trim($("#paypsw").val());
			if(paypsw == ''){
				showErrorMsg('请输入支付密码!');
				return false;
			}
			var index;
			$.ajax({  
				url: "{:U('/Mobilered/Cart/balance')}",  
				type: 'POST',  
				data:$("#cart4_form").serialize(),  
				dataType: 'json',  
				error: function(){ showErrorMsg('系统繁忙，请刷新后重试!');},
				beforeSend:function(){
					index = layer.open({type: 2,shadeClose: false});
				},
				success: function(r){
					layer.closeAll(index);
					if(r.status == 1){
						showErrorMsg('使用余额支付成功!');
						window.setTimeout("location.href = '{:U("/MobileRed/Order/order_list/type/WAITSEND")}';", 2000); 
					}else{
						showErrorMsg(r.info);
					}
				},
			});
			return false;
		}
		$('#cart4_form').submit();
		return;
   
        //微信JS支付
    }

    //监听返回事件
    jQuery(document).ready(function($) {
        //判断是否是线下
        var store_id =  "{$Request.param.store_id}";
        if(store_id!=""){  //如果当前是线下

            if (window.history && window.history.pushState) {

                $(window).on('popstate', function() {
                    var hashLocation = location.hash;
                    var hashSplit = hashLocation.split("#!/");
                    var hashName = hashSplit[1];

                    if (hashName !== '') {
                        var hash = window.location.hash;
                        if (hash === '') {
                            // alert('後退按鈕點擊');
                            nopayRuturnOrder();
                        }
                    }
                });

                window.history.pushState('forward', null, './#forward');
            }
        }
    });
    // nopayRuturnOrder();
    //未支付取消订单的操作
    function nopayRuturnOrder(){
        $.ajax({
            url:"{:url('Mobilered/Cart/nopayRuturnOrder')}",
            data:{"orderid":{$orderid}},
            dataType:"json",
            type:"POST",
            success:function(data){
                window.history.go(-1);
            }
        });
    }



</script>
	</body>
</html>
